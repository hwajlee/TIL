## 서브쿼리(Subquery)
---
- 쿼리 안의 쿼리
- 하위 쿼리의 결과를 상위 쿼리에서 사용하면 SQL 쿼리가 훨씬 간단해지는 장점이 있음 
- 서브쿼리는 위치에 따라 SELECT절, FROM절, WHERE절로 나뉨 
  - SELECT절에 [SELECT, FROM, WHERE]을 넣거나 
  - FROM절에 [SELECT, FROM, WHERE]을 넣거나 
  - WHERE절에 [SELECT, FROM, WHERE]을 넣는 구문을 의미 
- 가장 일반적인 것은 WHERE절이며, 실무에선 FROM절과 WHERE절을 가장 많이 사용함 
- 서브쿼리는 단일 행(single row) 또는 복수 행(multi row) 비교 연산자와 함께 사용 가능 
- 서브쿼리는 SELECT절, FROM절, HAVING절, ORDER BY절 등에서 사용 가능 
- 서브쿼리의 결과가 복수 행 결과를 반환하는 경우에는 IN, ALL, ANY 등의 복수 행 비교 연산자와 사용해야 함 (단일 행 연산자: '=', '<=' '>=' 등)
- 다중 컬럼 서브쿼리는 서브쿼리의 결과로 여러 개의 컬럼이 반환되어 메인 쿼리의 조건과 비교되는 데, SQL Server에서는 현재 지원하지 않는 기능
  
<br>

### 1. SELECT절 서브쿼리 
- SELECT절에 사용되는 서브쿼리는 **하나의 열처럼 사용**됨 
- 예제) [MEMBER], [ORDER] 테이블 간 공통값만 매칭하되, [ORDER]는 전부 & [MEMBER]는 gender 열만 나오게 하라
  
  - Join 활용 
  
    ```MySQL
    SELECT A.*, B.gender
    FROM [ORDER] A
    LEFT JOIN [MEMBER] B
    ON A.mem_no = B.mem.no
    ```

  - SELECT절 서브쿼리 활용 
  
    ```MySQL
    SELECT *, (SELECT gender 
                            FROM [MEMBER] B
                            WHERE B.mem_no = A.mem_no) AS gender
    FROM [ORDER] A
    ``` 

   - [ORDER] 테이블은 전체를 (A.*), 그리고 [MEMBER] 테이블의 'gender' 컬럼만 똑 떼어서 가져오는 것 
   - 후자를 하는 방법이 SELECT절 서브쿼리이며, **SELECT절 서브쿼리가 하나의 'gender' 컬럼처럼 사용되고 있음**
   - SELECT절 서브쿼리는 데이터의 양이 많을 수록 실행속도가 느려지기 때문에 거의 사용되지 않는 명령어 

<br>

### 2. FROM절 명령어 
- FROM절에 사용되는 서브쿼리는 **하나의 테이블**처럼 사용됨 
- 테이블처럼 사용되므로, **열 이름과 테이블 명을 꼭 명시해주어야 함** (FROM절 내 서브쿼리는 괄호를 치고 AS 명시)
- 예제) [ORDER] 테이블에서 회원번호(mem_no)별 주문금액(sales_amt) 합계를 집계하라 
  
  - GROUP BY 활용 
  
    ```MySQL
    SELECT mem_no, SUM(sales_amt) AS tot_amt
    FROM [ORDER]
    GROUP BY mem_no
    ``` 

   - FROM절 활용 
  
        ```MySQL
        SELECT *
        FROM (SELECT mem_no, SUM(sales_amt) AS tot_amt
                        FROM [ORDER]
                GROUP BY mem_no) A
        ```

   - 실전에서는 여러 가지 테이블을 조인시켜 가공하고, 1차ㅏ 가공한 결과물을 또 다시 2차 가공하는 등의 과정을 거치는 경우가 많음
   - 1차 가공한 결과를 테이블 형태로 다시 저장하면 좋겠지만 이것이 불가능한 경우엔 1차 가공물을 FROM절 서브쿼리에 넣어 하나의 테이블로 이용하는 경우가 많음

<br>

### 3. WHERE절 서브쿼리 
- 가장 대표적인 형태 
- 예제 1) [MEMBER] 테이블의 mem_no = '1000005'인 주문내역을 [ORDER] 테이블에서 조회해라
  
  ```MySQL
  SELECT * 
  FROM [ORDER]
  WHERE mem_no IN (SELECT mem_no FROM [MEMBER] WHERE mem_no = '1000005')
  ```
- 예제 2) [MEMBER] 테이블의 gender = 'man'인 주문내역을 [ORDER] 테이블에서 조회해라 
  
  ```MySQL
  SELECT *
  FROM [ORDER]
  WHERE mem_no IN (SELECT mem_no FROM [MEMBER] WHERE gender = 'man')
  ```
  - [MEMBER]와 [ORDER] 테이블의 공통열(key)이 mem_no이기 때문에, gender = 'man'인 mem_no를 WHERE절로부터 찾아내 조회 가능 

<br>

---
#### 참고자료
@ https://suy379.tistory.com/106